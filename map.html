<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Add a line to a map using a GeoJSON source</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.js"></script>
    <script src='https://unpkg.com/togeojson@0.16.0/togeojson.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map-container {
            width: 100%;
            flex: 1;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        #container {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #elevation-chart {
            height: 30%;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);

            display: flex;
            align-items: center;
            justify-content: center
        }

        #map-legend-container {
            position: relative;
        }

        #map-legend {
            position: absolute;
            bottom: 30px;
            left: 10px;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 100;

            display: flex;
            flex-direction: column;
            gap: 5px;
        }
    </style>
</head>

<body>

    <div id="container">
        <div id="map-container">
            <div id="map"></div>
            <div id="map-legend-container">
                <div id="map-legend"></div>
            </div>
        </div>
        <div id="elevation-chart"></div>
    </div>

    <script>
        const mainData = {}
        const elevationChart = document.getElementById('elevation-chart');
        const colorsArray = ['red', 'green', 'blue', 'yellow', 'purple', 'orange', 'pink', 'brown', 'black', 'gray']
        const mapLegend = document.getElementById('map-legend');

        const gpxFileURL = 'RinjaniApr2009.gpx';
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2VyZ2JlciIsImEiOiJja3dwOWgzeGQwYWdyMm9xb2pkMDFvYmNuIn0.H9AJ_NLmDNYMed6dvu_Q0A';
        const map = new mapboxgl.Map({
            container: 'map',
            //style: 'https://tiles.stadiamaps.com/styles/outdoors.json?key=c6948310-631b-491a-b1d9-d1f9186c03ae', // style URL
            style: 'https://tiles.stadiamaps.com/styles/outdoors.json?key=bc06701b-526f-47fe-afff-27877e93db72', // style URL
            center: { lng: 116.44699281267492, lat: -8.373418469943047 },
            zoom: 6.8
        });

        map.on('load', () => {

            map.addLayer({
                "id": "contour-labels",
                "type": "symbol",
                "source": {
                    type: 'vector',
                    url: 'mapbox://mapbox.mapbox-terrain-v2'
                },
                "source-layer": "contour",
                'layout': {
                    'visibility': 'visible',
                    'symbol-placement': 'line',
                    'text-field': ['concat', ['to-string', ['get', 'ele']], 'm']
                },
                'paint': {
                    'icon-color': '#877b59',
                    'icon-halo-width': 1,
                    'text-color': '#877b59',
                    'text-halo-width': 1
                },
                'filter': ['==', ['%', ['get', 'ele'], 100], 0]
            })

            map.addLayer({
                "id": "contours",
                "type": "line",
                "source": {
                    type: 'vector',
                    url: 'mapbox://mapbox.mapbox-terrain-v2'
                },
                "source-layer": "contour",
                'layout': {
                    'visibility': 'visible',
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color': '#877b59',
                    'line-width': 1
                },
                'filter': ['==', ['%', ['get', 'ele'], 100], 0]
            })

            map.addSource('route', {
                'type': 'geojson',
                'data': turf.featureCollection([])
            });
            map.addLayer({
                'id': 'route',
                'type': 'line',
                'source': 'route',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color': ['get', 'color'],
                    'line-width': 8
                }
            });

            map.addSource('point', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': []
                }
            });

            map.addLayer({
                'id': 'point',
                'type': 'circle',
                'source': 'point',
                'paint': {
                    'circle-radius': 10,
                    'circle-color': '#3887be'
                }
            });

            // Add a new source for the buffer
            map.addSource('routeBuffer', {
                'type': 'geojson',
                'data': {
                    'type': 'Feature',
                    'properties': {},
                    'geometry': {
                        'type': 'Polygon',
                        'coordinates': [[]]
                    }
                }
            });

            // Add a new layer for the buffer (optional, for visualization)
            map.addLayer({
                'id': 'routeBuffer',
                'type': 'fill',
                'source': 'routeBuffer',
                'layout': {},
                'paint': {
                    'fill-color': '#888',
                    'fill-opacity': 0.1
                }
            });

            fetch(gpxFileURL)
                .then(function (response) {
                    return response.text();
                })
                .then(function (xml) {
                    const geoJson = toGeoJSON.gpx(new DOMParser().parseFromString(xml, "text/xml"))
                    console.log('geoJson', geoJson);

                    geoJson.features.forEach((element, index) => {
                        element.properties.color = colorsArray[index % colorsArray.length]
                    });

                    addLegend(geoJson)

                    buildElevationChart(geoJson)
                    map.getSource("route").setData(geoJson)

                    mainData.geoJson = geoJson

                    const coords = turf.coordAll(geoJson);
                    const start = coords[0]
                    const end = coords[coords.length - 1]
                    addStartEnd({ label: "A", coords: start })
                    addStartEnd({ label: "B", coords: end })

                    const bbox = turf.bbox(geoJson)
                    console.log('bbox', bbox);
                    map.fitBounds(bbox, { padding: 50 })

                });

        });

        function addLegend(data) {
            mapLegend.innerHTML = ""

            const items = data.features.map(d => {
                mapLegend.appendChild(buildItem({
                    name: d.properties.name,
                    color: d.properties.color
                }))
            })

            function buildItem({ name, color }) {

                const container = document.createElement('div')
                container.style.display = "flex"
                container.style.gap = "5px"
                container.style.alignItems = "center"

                const div = document.createElement('div')
                div.style.display = "flex"
                div.style.alignItems = "center"
                div.innerText = name

                const colorLine = document.createElement('div')
                colorLine.style.width = "20px"
                colorLine.style.height = "5px"
                colorLine.style.backgroundColor = color

                container.appendChild(colorLine)
                container.appendChild(div)

                return container
            }
        }

        function addStartEnd({ label, coords }) {

            // Create a DOM element for each marker.
            const el = document.createElement('div');
            const width = 30
            const height = 30

            const text = document.createElement('span')
            text.innerText = label
            text.style.color = "white"
            text.style.fontSize = "1.5rem";
            el.appendChild(text)

            el.className = 'marker';
            el.style.backgroundColor = "rgba(0,0,0,1)"
            el.style.borderRadius = "5px"
            el.style.border = "1px solid gray"
            el.style.width = `${width}px`;
            el.style.height = `${height}px`;
            el.style.backgroundSize = '100%';
            el.style.display = "flex"
            el.style.alignItems = "center"
            el.style.justifyContent = "center"

            el.addEventListener('click', () => {
                window.alert("123");
            });

            // Add markers to the map.
            new mapboxgl.Marker(el)
                .setLngLat(coords)
                .addTo(map);
        }

        function buildElevationChart(geojson) {
            const coords = turf.coordAll(geojson);
            let elevation = coords.map(d => d[2]);

            // Calculate cumulative distances using Turf
            let cumulativeDistance = [0];
            for (let i = 1; i < coords.length; i++) {
                const from = turf.point([coords[i - 1][0], coords[i - 1][1]]);
                const to = turf.point([coords[i][0], coords[i][1]]);
                const distance = turf.distance(from, to, { units: 'kilometers' });
                cumulativeDistance.push(cumulativeDistance[i - 1] + distance);
            }

            const canvas = document.createElement('canvas');
            canvas.style.width = '100%';
            canvas.style.maxWidth = '1000px';
            canvas.style.height = '100%';
            elevationChart.appendChild(canvas);

            // Moving Average smoothing
            elevation = movingAverage(elevation, 20);

            const chart = new Chart(canvas, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Elevation',
                        data: elevation.map((elev, index) => ({ x: cumulativeDistance[index], y: elev })),
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 600,
                            title: {
                                display: true,
                                text: 'Elevation (m)'
                            },
                            ticks: {
                                callback: function (value) {
                                    return value + 'm';
                                }
                            }
                        },
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Distance (km)'
                            },
                            ticks: {
                                callback: function (value) {
                                    return value.toFixed(1) + 'km';
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `Elevation: ${context.parsed.y.toFixed(0)}m, Distance: ${context.parsed.x.toFixed(2)}km`;
                                }
                            }
                        }
                    }
                }
            });
        }



        // 1. Data Reduction
        function reduceData(data, labels, targetLength) {
            if (data.length <= targetLength) {
                return [data, labels];
            }

            const factor = Math.floor(data.length / targetLength);
            const reducedData = [];
            const reducedLabels = [];

            for (let i = 0; i < data.length; i += factor) {
                reducedData.push(data[i]);
                reducedLabels.push(labels[i]);
            }

            return [reducedData, reducedLabels];
        }

        // 2. Moving Average
        function movingAverage(data, windowSize) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                const start = Math.max(0, i - windowSize + 1);
                const end = i + 1;
                const window = data.slice(start, end);
                const average = window.reduce((sum, val) => sum + val, 0) / window.length;
                result.push(average);
            }
            return result;
        }
    </script>
</body>

</html>