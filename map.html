<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Add a line to a map using a GeoJSON source</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.2/mapbox-gl.js"></script>
    <script src='https://unpkg.com/togeojson@0.16.0/togeojson.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            width: 100%;
            flex: 1;
        }

        #container {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #elevation-chart {
            height: 30%;
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>

    <div id="container">
        <div id="map"></div>
        <div id="elevation-chart"></div>
    </div>

    <script>
        //https://api.open-elevation.com/api/v1/lookup?locations=-8.355792,116.487428
        //https://www.opentopodata.org/
        //https://api.opentopodata.org/v1/srtm30m?locations=-8.341961,116.498117
        //
        const mainData = {}
        const elevationChart = document.getElementById('elevation-chart');

        const gpxFileURL = 'RinjaniApr2009.gpx';
        mapboxgl.accessToken = 'pk.eyJ1Ijoic2VyZ2JlciIsImEiOiJja3dwOWgzeGQwYWdyMm9xb2pkMDFvYmNuIn0.H9AJ_NLmDNYMed6dvu_Q0A';
        const map = new mapboxgl.Map({
            container: 'map',
            //style: 'https://tiles.stadiamaps.com/styles/outdoors.json?key=c6948310-631b-491a-b1d9-d1f9186c03ae', // style URL
            style: 'https://tiles.stadiamaps.com/styles/outdoors.json?key=bc06701b-526f-47fe-afff-27877e93db72', // style URL
            center: { lng: 116.44699281267492, lat: -8.373418469943047 },
            zoom: 6.8
        });

        map.on('load', () => {

            map.addLayer({
                "id": "contour-labels",
                "type": "symbol",
                "source": {
                    type: 'vector',
                    url: 'mapbox://mapbox.mapbox-terrain-v2'
                },
                "source-layer": "contour",
                'layout': {
                    'visibility': 'visible',
                    'symbol-placement': 'line',
                    'text-field': ['concat', ['to-string', ['get', 'ele']], 'm']
                },
                'paint': {
                    'icon-color': '#877b59',
                    'icon-halo-width': 1,
                    'text-color': '#877b59',
                    'text-halo-width': 1
                },
                'filter': ['==', ['%', ['get', 'ele'], 100], 0]
            })

            map.addLayer({
                "id": "contours",
                "type": "line",
                "source": {
                    type: 'vector',
                    url: 'mapbox://mapbox.mapbox-terrain-v2'
                },
                "source-layer": "contour",
                'layout': {
                    'visibility': 'visible',
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color': '#877b59',
                    'line-width': 1
                },
                'filter': ['==', ['%', ['get', 'ele'], 100], 0]
            })

            map.addSource('route', {
                'type': 'geojson',
                'data': turf.featureCollection([])
            });
            map.addLayer({
                'id': 'route',
                'type': 'line',
                'source': 'route',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color': '#264BC2 ',
                    'line-width': 8
                }
            });

            map.addSource('point', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': []
                }
            });

            map.addLayer({
                'id': 'point',
                'type': 'circle',
                'source': 'point',
                'paint': {
                    'circle-radius': 10,
                    'circle-color': '#3887be'
                }
            });

            // Add a new source for the buffer
            map.addSource('routeBuffer', {
                'type': 'geojson',
                'data': {
                    'type': 'Feature',
                    'properties': {},
                    'geometry': {
                        'type': 'Polygon',
                        'coordinates': [[]]
                    }
                }
            });

            // Add a new layer for the buffer (optional, for visualization)
            map.addLayer({
                'id': 'routeBuffer',
                'type': 'fill',
                'source': 'routeBuffer',
                'layout': {},
                'paint': {
                    'fill-color': '#888',
                    'fill-opacity': 0.1
                }
            });

            // Function to update the buffer
            function updateBuffer(route, distance) {
                const buffered = turf.buffer(route, distance, { units: 'kilometers' });
                map.getSource('routeBuffer').setData(buffered);
                return buffered;
            }

            // Update the mousemove event
            map.on('mousemove', (e) => {
                const coordinates = e.lngLat;
                const point = turf.point([coordinates.lng, coordinates.lat]);


                if (!map.getSource('route') || !map.getSource('route')._data.geometry.coordinates) return

                const line = turf.lineString(map.getSource('route')._data.geometry.coordinates);

                // Create a buffer around the line (adjust the distance as needed)
                const buffered = updateBuffer(line, 1); // 0.1 km buffer

                // Check if the mouse point is within the buffer
                if (turf.booleanPointInPolygon(point, buffered)) {
                    const snapped = turf.nearestPointOnLine(line, point);

                    // Update the point location
                    map.getSource('point').setData({
                        'type': 'Feature',
                        'properties': {},
                        'geometry': {
                            'type': 'Point',
                            'coordinates': snapped.geometry.coordinates
                        }
                    });

                    const elevation = map.queryTerrainElevation(snapped.geometry.coordinates);
                    console.log('elevation', elevation);
                }
            });

            fetch(gpxFileURL)
                .then(function (response) {
                    return response.text();
                })
                .then(function (xml) {
                    const geoJson = toGeoJSON.gpx(new DOMParser().parseFromString(xml, "text/xml"))
                    console.log('geoJson', geoJson);

                    buildElevationChart(geoJson)

                    //points to linestring 
                    const lineCoords = turf.coordAll(geoJson).map(d => [d[0], d[1]])
                    const lineString = turf.lineString(lineCoords)

                    map.getSource("route").setData(lineString)

                    mainData.geoJson = lineString

                    const coords = turf.coordAll(geoJson);
                    const start = coords[0]
                    const end = coords[coords.length - 1]

                    addStartEnd({ label: "A", coords: start })
                    addStartEnd({ label: "B", coords: end })

                    var bounds = new mapboxgl.LngLatBounds();
                    lineCoords.forEach(function (coord) {
                        bounds.extend(coord);
                    });
                    map.fitBounds(bounds, { padding: 150 });

                });

        });

        function addStartEnd({ label, coords }) {

            // Create a DOM element for each marker.
            const el = document.createElement('div');
            const width = 30
            const height = 30

            const text = document.createElement('span')
            text.innerText = label
            text.style.color = "white"
            text.style.fontSize = "1.5rem";
            el.appendChild(text)

            el.className = 'marker';
            el.style.backgroundColor = "rgba(0,0,0,1)"
            el.style.borderRadius = "5px"
            el.style.border = "1px solid gray"
            el.style.width = `${width}px`;
            el.style.height = `${height}px`;
            el.style.backgroundSize = '100%';
            el.style.display = "flex"
            el.style.alignItems = "center"
            el.style.justifyContent = "center"

            el.addEventListener('click', () => {
                window.alert("123");
            });

            // Add markers to the map.
            new mapboxgl.Marker(el)
                .setLngLat(coords)
                .addTo(map);
        }

        function buildElevationChart(geojson) {
            const coords = turf.coordAll(geojson);
            const elevation = coords.map(d => d[2])
            const distance = coords.map((d, i) => i)

            console.log('elevation', elevation);
            console.log('distance', distance);

            const canvas = document.createElement('canvas');
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            elevationChart.appendChild(canvas);

            const chart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: distance,
                    datasets: [{
                        label: 'Elevation',
                        data: elevation,
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 3,
                        fill: false
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>